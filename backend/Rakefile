task :boot do
  require './boot'
end

namespace :db do
  desc 'Migrate the database (options: VERSION=x)'
  task :migrate => :boot do
    ActiveRecord::Migration.verbose = true
    ActiveRecord::Migrator.migrate 'db/migrate', ENV['VERSION'] ? ENV['VERSION'].to_i : nil
  end

  desc 'Rolls the schema back to the previous version (specify steps w/ STEP=n)'
  task :rollback => :boot do
    ActiveRecord::Migrator.rollback 'db/migrate', ENV['STEP'] ? ENV['STEP'].to_i : 1
  end

  desc 'Populate database with sample data'
  task :seed => :boot do
    Application.load_models!
    require 'db/seeds'
  end
end

namespace :spec do
  require 'rspec/core/rake_task'

  namespace :unit do
    desc 'Run model unit tests'
    RSpec::Core::RakeTask.new(:models) do |task|
      task.verbose = false
      task.pattern = 'spec/models/**/*_spec.rb'
      task.rspec_opts = '--profile'
    end

    task :all => [:models]
  end

  namespace :integration do
    desc 'Run common usecase integration tests'
    RSpec::Core::RakeTask.new(:usecases) do |task|
      task.verbose = false
      task.pattern = 'spec/integration/**/*_spec.rb'
      task.rspec_opts == '--profile'
    end

    task :all => [:usecases]
  end

  task :all => ['unit:all', 'integration:all']
end
